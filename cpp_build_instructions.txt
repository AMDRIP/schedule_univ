# Инструкция по сборке C++ нативных модулей

Это руководство поможет вам собрать нативные C++ модули для приложения "Расписание ВУЗ". Модули используются для высокопроизводительного составления расписания с поддержкой параллельной обработки через OpenMP.

## Обзор

Приложение использует нативный аддон Node.js, написанный на C++, для эффективного решения задачи составления расписания. Код использует:
- **OpenMP** для параллельных вычислений (симуляция отжига в нескольких потоках)
- **N-API** для интеграции с Node.js
- **node-gyp** для сборки нативных модулей

## Требования к системе по платформам

### Windows

**Обязательные компоненты:**
1. **Node.js** (версия 16 или новее) - https://nodejs.org/
2. **Python** (версия 3.x) - https://www.python.org/downloads/
3. **Visual Studio Build Tools** (2017 или новее):
   - Скачайте Build Tools: https://visualstudio.microsoft.com/downloads/
   - Установите компонент "Desktop development with C++"
   - **Важно:** Убедитесь, что установлены MSBuild и MSVC compiler

**Проверка установки:**
```cmd
node --version
python --version
where msbuild
```

### macOS

**Обязательные компоненты:**
1. **Node.js** (версия 16 или новее)
2. **Xcode Command Line Tools**:
   ```bash
   xcode-select --install
   ```
3. **Python** (обычно уже установлен)

**Для поддержки OpenMP:**
```bash
brew install libomp
```

### Linux (Ubuntu/Debian)

**Обязательные компоненты:**
```bash
sudo apt-get update
sudo apt-get install -y nodejs npm python3 build-essential
```

**Для поддержки OpenMP:**
```bash
sudo apt-get install -y libomp-dev
```

## Установка node-gyp

После установки необходимых инструментов установите node-gyp глобально:

```bash
npm install -g node-gyp
```

## Конфигурация OpenMP

OpenMP используется для параллельного выполнения алгоритма составления расписания, что значительно ускоряет работу.

### Windows (Visual Studio)

OpenMP поддерживается из коробки в MSVC. Убедитесь, что в файле `binding.gyp` присутствует флаг `/openmp`:

```gyp
'msvs_settings': {
  'VCCLCompilerTool': {
    'AdditionalOptions': [ '/openmp' ]
  }
}
```

### macOS

Для macOS необходимо настроить компилятор clang с поддержкой OpenMP:

```bash
# Установите libomp через Homebrew
brew install libomp

# Установите переменные окружения
export LDFLAGS="-L/usr/local/opt/libomp/lib"
export CPPFLAGS="-I/usr/local/opt/libomp/include"
```

### Linux

GCC по умолчанию поддерживает OpenMP. Убедитесь, что установлен пакет `libomp-dev`:

```bash
sudo apt-get install libomp-dev
```

## Сборка нативных модулей

### Шаг 1: Установка зависимостей проекта

Перейдите в корневую директорию проекта и установите все зависимости:

```bash
cd /путь/к/проекту
npm install
```

### Шаг 2: Сборка нативного модуля

Выполните одну из следующих команд:

**Автоматическая сборка (рекомендуется):**
```bash
npm run rebuild
```

**Ручная сборка через node-gyp:**
```bash
node-gyp rebuild
```

**Очистка и полная пересборка:**
```bash
node-gyp clean
node-gyp configure
node-gyp build
```

### Шаг 3: Проверка сборки

После успешной сборки в директории `native/build/Release/` должен появиться файл `scheduler.node`.

Проверьте работу модуля, запустив приложение:

```bash
npm start
```

## Полный процесс сборки (build_all.bat)

Для Windows предоставлен скрипт `build_all.bat`, который выполняет все этапы сборки автоматически:

1. Установка зависимостей (`npm install`)
2. Пересборка нативных модулей (`npm run rebuild`)
3. Сборка JS/CSS ресурсов (`npm run build`)
4. Создание дистрибутива (`npm run dist`)

Запустите скрипт:
```cmd
build_all.bat
```

## Устранение неполадок

### Проблема: `node-gyp` не найден

**Решение:**
```bash
npm install -g node-gyp
```

### Проблема: "Python not found"

**Решение (Windows):**
1. Установите Python 3.x
2. Добавьте Python в PATH
3. Укажите путь к Python для npm:
```cmd
npm config set python "C:\Python39\python.exe"
```

**Решение (Unix):**
```bash
sudo apt-get install python3
# или
brew install python3
```

### Проблема: "MSBuild not found" (Windows)

**Решение:**
1. Установите Visual Studio Build Tools
2. Убедитесь, что компонент "Desktop development with C++" установлен
3. Перезапустите командную строку

### Проблема: OpenMP не работает / предупреждения компиляции

**Windows:**
- Убедитесь, что установлена полная версия Visual Studio Build Tools
- Проверьте, что в `binding.gyp` есть флаг `/openmp`

**macOS:**
```bash
# Переустановите libomp
brew reinstall libomp

# Установите переменные окружения
export LDFLAGS="-L/usr/local/opt/libomp/lib"
export CPPFLAGS="-I/usr/local/opt/libomp/include"

# Пересоберите
npm run rebuild
```

**Linux:**
```bash
# Установите библиотеки OpenMP
sudo apt-get install libomp-dev

# Пересоберите
npm run rebuild
```

### Проблема: "Cannot find module 'scheduler.node'"

**Решение:**
1. Убедитесь, что сборка завершилась успешно
2. Проверьте наличие файла `native/build/Release/scheduler.node`
3. Если файл отсутствует, пересоберите модуль:
```bash
npm run rebuild
```

### Проблема: Ошибки компиляции C++

**Решение:**
1. Убедитесь, что используется совместимая версия Node.js (16+)
2. Обновите node-gyp:
```bash
npm install -g node-gyp@latest
```
3. Очистите кэш и пересоберите:
```bash
node-gyp clean
npm run rebuild
```

## Проверка производительности

После успешной сборки с OpenMP вы можете проверить использование параллельных вычислений:

1. Откройте приложение
2. Перейдите в раздел "Составление расписания"
3. Запустите эвристический планировщик
4. В консоли должно быть сообщение о количестве используемых потоков

Количество потоков определяется автоматически на основе числа ядер процессора (максимум 8).

## Структура нативного кода

```
native/
├── scheduler.h           - Заголовочный файл с определениями классов
├── scheduler.cc          - Основная логика планировщика с OpenMP
├── scheduler_wrapper.cc  - Обёртка для интеграции с Node.js (N-API)
├── binding.gyp           - Конфигурация сборки для node-gyp
└── build/                - Директория с собранными модулями (создаётся автоматически)
    └── Release/
        └── scheduler.node - Скомпилированный нативный модуль
```

## Дополнительная информация

### О binding.gyp

Файл `binding.gyp` содержит конфигурацию сборки. Основные параметры:

- `target_name`: имя выходного модуля
- `sources`: список исходных файлов C++
- `include_dirs`: директории с заголовочными файлами
- `cflags_cc`: флаги компилятора C++
- `msvs_settings`: специфичные настройки для Visual Studio (Windows)
- `xcode_settings`: специфичные настройки для Xcode (macOS)

### Альтернативные методы сборки

Если стандартная сборка не работает, попробуйте:

```bash
# Сборка в режиме отладки
node-gyp rebuild --debug

# Сборка с подробным выводом
node-gyp rebuild --verbose

# Указание конкретной версии Node.js
node-gyp rebuild --target=16.0.0
```

## Контакты и поддержка

При возникновении проблем со сборкой:
1. Проверьте логи сборки на наличие конкретных ошибок
2. Убедитесь, что установлены все необходимые компоненты для вашей платформы
3. Откройте issue в репозитории проекта с подробным описанием проблемы

---

**Автор:** Дмитрий Власов
**Версия документа:** 1.0
**Дата:** 2025-11-28
